<template>
    <div class="page" id="doctor-agregar-pago">
        <div class="page-content">
            <div class="header">
                <div class="addPay">
                    <a class="">
                        <i class="material-icons">chevron_left</i>
                    </a>
                    <p class="title1">Nuevo pago</p>
                </div>
            </div>
            <div class="list">
                <ul>
                    <li>
                        <div class="card card-outline pagos add" id="patient">
                            <div class="rectangle light-blue"></div>
                            <div class="card-content card-content-padding">
                                <i class="material-icons light-blue">
                                    person
                                </i>
                                <div class="data">
                                    <p class="light-blue">Paciente</p>
                                    <p class="text"></p>
                                </div>
                                <i class="material-icons light-blue">
                                    chevron_right
                                </i>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="card card-outline pagos add" id="pay">
                            <div class="rectangle turquoise"></div>
                            <div class="card-content card-content-padding">
                                <i class="material-icons turquoise">
                                    room
                                </i>
                                <div class="data">
                                    <p class="turquoise">Seleccion de pago</p>
                                    <p class="text"></p>
                                </div>
                                <i class="material-icons turquoise">
                                    chevron_right
                                </i>
                            </div>
                        </div>
                    </li>
                    <li>
                        <div class="card card-outline pagos add popover-open" data-popover=".popover-pay" id="type">
                            <div class="rectangle light-blue"></div>
                            <div class="card-content card-content-padding">
                                <i class="material-icons light-blue">
                                    credit_card
                                </i>
                                <div class="data">
                                    <p class="light-blue">Metodo de pago</p>
                                    <p class="text"></p>
                                </div>
                                <a class="popover-open" data-popover=".popover-pay">
                                    <i class="material-icons light-blue arrow">
                                        keyboard_arrow_down
                                    </i>
                                </a>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="container">
                <div class="btn-2">
                    <a href="">
                        <p>Siguiente </p>
                        <i class="material-icons white">chevron_right</i>
                    </a>
                </div>
            </div>
        </div>

        <div class="popover popover-pay">
            <div class="popover-inner">
                <div class="list">
                    <ul>
                        <li><a class="list-button item-link option transfer popover-close" href="#">Tranferencia
                                electronica</a></li>
                        <hr>
                        <li><a class="list-button item-link option cash popover-close" href="#">Efectivo</a></li>
                        <hr>
                        <li><a class="list-button item-link option credit_debit popover-close" href="#">Tarjeta de
                                Credito /
                                Debito</a></li>
                        <hr>
                        <li><a class="list-button item-link option bank popover-close" href="#">Ingreso Bancario</a>
                        </li>
                        <hr>
                        <li><a class="list-button item-link light-blue popover-close" href="#">Agregar Metodo</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</template>
<script>
    import $$ from 'dom7';

    export default {
        on: {
            pageInit: function(e, page) {
                var self = this;
                var app = self.$app;
                let pago, paciente, metodo;

                disableButton();
                //checar
                app.data.store.getItem('pago-pend').then(function(value) {
                    let consulta = localStorage.getItem('consulta');
                    if (consulta) {
                        $$('.card#pay').attr('style', 'filter: saturate(0)');
                        $$('.card#pay').off('click');
                    } else {
                        app.data.store.getItem('pago-pend-id').then(function(val) {
                            $$('#doctor-agregar-pago #pay .card-content .data .text').text(value);
                            $$('#doctor-agregar-pago #pay .card-content .data .text').data('id', val);
                            pago = value == null ? false : true;
                            //trigger para checkar values
                            if (value != null) $$(document).trigger("checkValues");
                        });
                    }
                });

                app.data.store.getItem('pago-patient').then(function(value) {
                    app.data.store.getItem('pago-patient-id').then(function(val) {
                        $$('#doctor-agregar-pago #patient .card-content .data .text').text(value);
                        $$('#doctor-agregar-pago #patient .card-content .data .text').data('id', val);
                        //check
                        paciente = value == null ? false : true;
                        //trigger para checkar values
                        if (value != null) $$(document).trigger("checkValues");
                    });
                });

                $$('.popover-pay a.option').click(function(x) {
                    let row = $$(this);
                    row.parent().parent().find('.active').removeClass('active');
                    row.addClass('active');
                    $$('#doctor-agregar-pago #type .card-content .data .text').text(row.text());
                    metodo = true;
                    $$(document).trigger("checkValues");
                });

                $$('.card#pay').click(function(x) {
                    app.methods.redirectTo('doctor-pagos-pendientes');
                });

                $$('.card#patient').click(function(x) {
                    app.data.store.setItem('search', 'patients_pagos').then(function(value) {
                        app.methods.redirectTo('search-module');
                    });
                });


                $$('#doctor-agregar-pago .header a').click(function(val) {
                    let consulta = localStorage.getItem('consulta');
                    if (consulta) {
                        app.methods.redirectTo('nueva-consulta');
                    } else {
                        app.data.store.getItem('back_pago').then(function(value) {
                            localStorage.clear();
                            localStorage.setItem('login-user', sessionStorage.getItem('user'));
                            localStorage.setItem('login-key', sessionStorage.getItem('key'));
                            if (value == 'paciente') {
                                app.methods.redirectTo('paciente-perfil');
                            } else {
                                app.data.store.clear().then(
                                    function() {
                                        app.methods.redirectTo('home');
                                    }
                                );
                            }
                        });
                    }
                });

                $$(document).on('checkValues', function(val) {
                    //si los 3 valores estan activa boton
                    let consulta = localStorage.getItem('consulta');
                    if (consulta) {
                        if (metodo && paciente) {
                            $$('.container .btn-2 a').removeClass('grey');
                            $$('.container .btn-2 a').click(function(x) {
                                app.data.store.setItem('metodo', $$('#doctor-agregar-pago #type .card-content .data .text').text()).then(function() {
                                    app.methods.redirectTo('doctor-agregar-pago-info');
                                });
                            });
                        }
                    } else {
                        if (metodo && paciente && pago) {
                            $$('.container .btn-2 a').removeClass('grey');
                            $$('.container .btn-2 a').click(function(x) {
                                app.data.store.setItem('metodo', $$('#doctor-agregar-pago #type .card-content .data .text').text()).then(function() {
                                    app.methods.redirectTo('doctor-agregar-pago-info');
                                });
                            });
                        }
                    }
                });

                function disableButton() {
                    $$('#doctor-agregar-pago .btn-2 a').addClass('grey');
                    $$('#doctor-agregar-pago .btn-2 a').off('click');
                }
            }
        }
    }
</script>