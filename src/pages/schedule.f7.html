<template>
    <div class="page schedule" data-name="schedule" id="schedule">

        <div class="header schedule">
            <div class="toolbar tabbar tabbar-scrollable toolbar-top" id='header-toolbar'>
                <div class="toolbar-inner" id="header-toolbar-inner">
                </div>
            </div>
        </div>

        <!--tool bar-->
        <div class="toolbar tabbar tabbar-labels toolbar-bottom menu">
            <div class="toolbar-inner">
                <a href="/home" class="tab-link profile">
                    <i class="icon material-icons">person</i>
                    <!-- <img src="//api.mydoctorize.com/files/user/userdetails/99/50.png" alt="not found"> -->
                </a>
                <a href="/schedule" class="tab-link tab-link-active ">
                    <i class="icon material-icons">today</i>
                </a>
                <a href="#" class="tab-link">
                </a>
                <a href="/doctor/pagos" class="tab-link">
                    <i class="icon material-icons">monetization_on</i>
                </a>
                <a href="#" class="tab-link">
                    <i class="icon material-icons">notifications</i>
                </a>
            </div>
            <a class="add-circle popover-open" data-popover=".popover-menu">
                <div class="back-white"></div>
                <img src="/static/images/add_circle_24px_v2.svg" class="dynamic-sheet" alt="">
            </a>
        </div>
        <!--tabs-->
        <div class="tabs">

        </div>
    </div>
</template>
<script>
    import $$ from 'dom7';
    export default {
        on: {
            pageInit: function(e, page) {
                var self = this;
                var app = self.$app;
                var z, today, y, i, a;
                var moment = require('moment');
                moment.locale('es');
                moment().format();

                var doctor = JSON.parse(sessionStorage.getItem('user'));

                if (doctor != null && doctor != 'undefined' && doctor != '') {
                    $$(".toolbar .profile").html('<img src="' + app.data.url + doctor.img_data.url + '" alt="not found">');
                }

                /* app.preloader.show('blue'); */
                /* abre preloader */

                /*
                    crea la subnavbar con los 30 dias a partir de hoy
                */
                z = moment(), today = moment(), y = moment(z).add(1, 'M'), i = 1;
                while (z.isBefore(y)) {
                    $$('#header-toolbar-inner').append(
                        '<a href="#tab-' + i + '" class="tab-link" id="D' + z.format("DD-MMMM") + '" data-date="' + moment(z).format("YYYY-MM-DD") + '">' +
                        '<p class="num">' + z.date() + ' </p>' +
                        '<p>' + z.format('MMM') + ' </p>' +
                        '</a>');
                    $$('.tabs').append(
                        '<div id="tab-' + i + '" class="page-content login-screen-content tab hide-navbar-on-scroll tab">' +
                        '<div class="list">' +
                        '<ul >' +
                        '</ul>' +
                        '</div>' +
                        '</div>'
                    );
                    if (z.isSame(today)) {
                        $$('#D' + z.format("DD-MMMM")).addClass('tab-link-active');
                        $$('#D' + z.format("DD-MMMM")).addClass('tab-link-today');
                        $$('#schedule #tab-' + i).addClass('tab-active');
                    }
                    i++;
                    z.add(1, 'd')
                }
                /*--------------------------------------------------------------------------------*/

                /* llena pagina 1 cuando inicia */
                fillPage('#tab-1', moment().format("YYYY-MM-DD"));

                /* llena la pagina a donde se le de click */
                $$('#header-toolbar-inner .tab-link').click(function(e) {
                    $$(this).parent().children('.tab-link-active').removeClass('tab-link-active');
                    $$(this).addClass('tab-link-active');
                    $$('.tabs').children('.tab-active').removeClass('tab-active');
                    $$('.tabs').children($$(this).attr('href')).addClass('tab-active');
                    fillPage($$(this).attr('href'), $$(this).data("date"));


                });


                /* esconde la subnavbar y el icono de la toolbar cuando una carta se expande */
                /* $$(document).on('card:beforeopen', function(e) {
                    $$('.header.schedule').hide();
                    $$('.menu').hide();
                    $$(e.srcElement).find('.show').hide();
                    $$(e.srcElement).find('.card-header').addClass('header-turquoise');
                }); */
                /* regresa la subnavbar y el icono de la tool bar cuando la carta se comprime */
                /* $$(document).on('card:close', function(e) {
                    $$('.header.schedule').show();
                    $$('.menu').show();
                    $$(e.srcElement).find('.show').show();
                }); */

                /* funcion para llenar la pagina dinamicamente */
                function fillPage(x, y) {
                    let flag = true;

                    /* limpia la pagina antes de poner algo */
                    $$('#schedule ' + x).children('.list').children('ul').empty();

                    /* trae las citas del doctor */ //cmabiar por el endpoint para traer solo las citas del dia
                    app.request.get(app.data.url + '/citas?doctor.id=' + doctor.doctor.id + '&fecha=' + y,
                        function(e) {
                            let z = JSON.parse(e);
                            console.log(z);

                            if (z && z.length > 0) {
                                //quitar el finltro cuando sea por dia

                                z.sort(function(a, b) {
                                    if (moment(a.fecha).isBefore(moment(b.fecha))) {
                                        return -1;
                                    } else if (moment(a.fecha).isAfter(moment(b.fecha))) {
                                        return 1;
                                    }
                                    return 0;
                                });

                                /* comienza a llenar la pagina */
                                for (let i = 0; i < z.length; i++) {
                                    let j = moment().hour(z[i].hora.split(':')[0]).minute(z[i].hora.split(':')[1]);
                                    let k = eval(i) + 1;
                                    let minute = '00';
                                    let minute2 = '00';

                                    /* pone la linea de la hora si es el primer elemento */
                                    if (flag) {
                                        if (j.minute() == 30) minute = '30';
                                        $$(x).children('.list').children('ul').append(
                                            '<li class="item-divider">' +
                                            '<i class="icon material-icons">watch_later</i>' +
                                            j.hour() + ':' + minute +
                                            '<hr>' +
                                            '</li>');
                                    }

                                    /* j.add(30, 'm'); */
                                    /* console.log(j.format('HH:mm')); */
                                    let h = j.hour();
                                    if (j.minute() == 30) {
                                        h = eval(j.hour() + 1);
                                        minute = '30';
                                        minute2 = '00';
                                    } else {
                                        minute = '00';
                                        minute2 = '30';
                                    }

                                    /* pone la carta de la cita */
                                    $$('#schedule ' + x).children('.list').children('ul').append(
                                        '<div class="card v3">' + /* card-expandable */
                                        '<div class="rectangle turquoise card-opened-fade-out"></div>' +
                                        '<ditogglev class="card-content">' +
                                        '<div class="card-content-padding show card-opened-fade-out">' +
                                        '<div class="dis-col">' +
                                        '<p class="title dark-blue card-opened-fade-out">CONSULTA</p>' +
                                        '<p class="text-1 dark-blue card-opened-fade-out">' + z[i].nombre + '</p>' +
                                        '<p class="text-2 dark-blue card-opened-fade-out">' + z[i].consultorio.nombre + '</p>' +
                                        '<p class="footer light-blue card-opened-fade-out">' +
                                        '<i class="icon material-icons time">watch_later</i>' +
                                        j.hour() + ':' + j.format('mm') + ' - ' + h + ':' + minute2 +
                                        '</p>' +
                                        '</div>' +
                                        '<i class="icon f7-icons chevron card-opened-fade-out">chevron_right</i>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>'
                                    );

                                    $$('#schedule .card').off('click');
                                    $$('#schedule .card').click(function(val) {
                                        console.log('redirect to consulta');
                                    });

                                    /* checa cuando cerrar la lista y cuando no */
                                    if (k < z.length) {
                                        let m = moment().hour(z[k].hora.split(':')[0]).minute(z[k].hora.split(':')[1]);
                                        let n = moment(j).add(30, 'm');
                                        if (m.format('HH:mm') != n.format('HH:mm')) { /* si el elemento no precede a otro cierra la lista */
                                            closeList(j)
                                        } else { /* si el elemento tiene un sucesor sigue con la lista */
                                            flag = false;
                                        }
                                    } else { /* si el elemento es el ultimo cierra la lista */
                                        closeList(j)
                                    }
                                }
                            } else {
                                let hour = moment(),
                                    minute;
                                flag = true;
                                if (hour.minute() >= 30) {
                                    minute = '00';
                                    hour.add(1, 'H');
                                } else {
                                    minute = '30'
                                }
                                $$('#schedule ' + x).children('.list').children('ul').append(
                                    '<li class="item-divider">' +
                                    '<i class="icon material-icons">watch_later</i>' +
                                    hour.hour() + ':' + minute +
                                    '<hr>' +
                                    '</li>' +
                                    '<li>' +
                                    '<div class="row">' +
                                    '<div class="col-30"></div>' +
                                    '<div class="col-40">' +
                                    '<div class="schedule-icon">' +
                                    '<i class="material-icons">event_note</i>' +
                                    '</div>' +
                                    '</div>' +
                                    '<div class="col-30"></div>' +
                                    '</div>' +
                                    '</li>' +
                                    '<li>' +
                                    '<div class="row">' +
                                    '<div class="col-15"></div>' +
                                    '<div class="col-70">' +
                                    '<p>' +
                                    'No se tienen citas el d√≠a de hoy.<br>Agregar una.' +
                                    '</p>' +
                                    '</div>' +
                                    '<div class="col-15"></div>' +
                                    '</div>' +
                                    '</li>' +
                                    '<li>' +
                                    '<div class="row">' +
                                    '<div class="col-30"></div>' +
                                    '<div class="col-40">' +
                                    '<div class="icon-fab">' +
                                    '<i class="icon material-icons">add_circle</i>' +
                                    '</div>' +
                                    '</div>' +
                                    '<div class="col-30"></div>' +
                                    '</div>' +
                                    '</li>'
                                );
                            }
                            $$('.icon-fab').click(function(e) {
                                app.methods.redirectTo('agendar-cita');
                            });

                            app.preloader.hide();
                        }
                    );

                    function closeList(a) {
                        let minute;
                        flag = true;
                        a.add(30, 'm');
                        console.log(a.format('HH:mm'));

                        if (a.format('mm') == 30) {
                            minute = '30';
                        } else {
                            minute = '00'
                        }
                        $$('#schedule ' + x).children('.list').children('ul').append(
                            '<li class="item-divider">' +
                            '<i class="icon material-icons">watch_later</i>' +
                            a.hour() + ':' + minute +
                            '<hr>' +
                            '</li>' +
                            '<li>' +
                            '<div class="row">' +
                            '<div class="col-30"></div>' +
                            '<div class="col-40">' +
                            '<div class="icon-fab">' +
                            '<i class="icon material-icons">add_circle</i>' +
                            '</div>' +
                            '</div>' +
                            '<div class="col-30"></div>' +
                            '</div>' +
                            '</li>'
                        );
                    }
                }

            }
        }
    }
</script>